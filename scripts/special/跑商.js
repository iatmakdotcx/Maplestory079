var status = 0;
var bossid = -1;
var num = 0;
var times = 99999999;//可跑商次数
var index1 = -1;
var index2 = -1;
var itemlist=[
[40000	,4000017],
[40000	,4000082],
[50000	,4000393],
[50000	,4000394],
[50000	,4000395],
[50000	,4000396],
[50000	,4000021],
[50000	,4000397],
[50000	,4000403],
[50000	,4000398],
[60000	,4000030],
[100000	,4000157],
[180000	,4000291],
[330000	,4000247],
[360000	,4000005],
[360000	,4000331],
[360000	,4000098],
[360000	,4000107],
[360000	,4000013],
[360000	,4000357],
[360000	,4000078],
[360000	,4000205],
[360000	,4000438],
[360000	,4000283],
[360000	,4000052],
[360000	,4000419],
[360000	,4000144],
[360000	,4000231],
[360000	,4000132],
[360000	,4000182],
[360000	,4000269],
[360000	,4000450],
[360000	,4000382],
[360000	,4000494],
[360000	,4000089],
[360000	,4000006],
[360000	,4000328],
[360000	,4000161],
[360000	,4000095],
[360000	,4000035],
[360000	,4000358],
[360000	,4000101],
[360000	,4000158],
[360000	,4000284],
[360000	,4000177],
[360000	,4000354],
[360000	,4000185],
[360000	,4000147],
[360000	,4000133],
[360000	,4000262],
[360000	,4000270],
[360000	,4000452],
[360000	,4000369],
[360000	,4000383],
[360000	,4000473],
[360000	,4000493],
[360000	,4000254],
[360000	,4000090],
[360000	,4000018],
[360000	,4000326],
[360000	,4000163],
[360000	,4000353],
[360000	,4000043],
[360000	,4000359],
[360000	,4000102],
[360000	,4000159],
[360000	,4000412],
[360000	,4000293],
[360000	,4000206],
[360000	,4000363],
[360000	,4000186],
[360000	,4000179],
[360000	,4000418],
[360000	,4000263],
[50000	,4000151],
[360000	,4000453],
[360000	,4000370],
[10000	,4000384],
[360000	,4000475],
[360000	,4000499],
[360000	,4000255],
[360000	,4000091],
[360000	,4000195],
[360000	,4000327],
[360000	,4000162],
[360000	,4000352],
[360000	,4000100],
[360000	,4000014],
[360000	,4000111],
[360000	,4000169],
[360000	,4000048],
[360000	,4000294],
[360000	,4000083],
[10000	,4000040],
[360000	,4000207],
[360000	,4000028],
[360000	,4000355],
[360000	,4000264],
[360000	,4000152],
[360000	,4000454],
[360000	,4000372],
[360000	,4000385],
[360000	,4000476],
[360000	,4000502],
[360000	,4000256],
[360000	,4000092],
[360000	,4000011],
[360000	,4000333],
[360000	,4000160],
[360000	,4000356],
[360000	,4000167],
[360000	,4000112],
[360000	,4000178],
[360000	,4000081],
[360000	,4000286],
[360000	,4000084],
[360000	,4000050],
[360000	,4000049],
[360000	,4000046],
[50000	,4000054],
[360000	,4000265],
[10000	,4000235],
[360000	,4000455],
[360000	,4000366],
[360000	,4000501],
[360000	,4000093],
[50000	,4000068],
[360000	,4000010],
[360000	,4000164],
[360000	,4000024],
[360000	,4000059],
[360000	,4000045],
[360000	,4000114],
[360000	,4000276],
[360000	,4000170],
[360000	,4000287],
[360000	,4000085],
[360000	,4000128],
[10000	,4000176],
[360000	,4000208],
[360000	,4000238],
[360000	,4000134],
[10000	,4000243],
[360000	,4000457],
[360000	,4000367],
[360000	,4000431],
[360000	,4000478],
[360000	,4000500],
[360000	,4000258],
[10000	,4000094],
[360000	,4000015],
[360000	,4000196],
[360000	,4000073],
[20000	,4000067],
[360000	,4000062],
[360000	,4000117],
[360000	,4000277],
[360000	,4000172],
[360000	,4000288],
[360000	,4000437],
[360000	,4000173],
[360000	,4000130],
[360000	,4000297],
[360000	,4000239],
[360000	,4000135],
[360000	,4000272],
[360000	,4000458],
[360000	,4000371],
[360000	,4000430],
[360000	,4000507],
[360000	,4000259],
[360000	,4000002],
[360000	,4000350],
[360000	,4000197],
[360000	,4000108],
[360000	,4000099],
[10000	,4000124],
[360000	,4000118],
[360000	,4000278],
[360000	,4000171],
[360000	,4000298],
[360000	,4000439],
[360000	,4000285],
[100000	,4000056],
[100000	,4000053],
[360000	,4000240],
[360000	,4000183],
[360000	,4000271],
[20000	,4000257],
[360000	,4000377],
[360000	,4000432],
[360000	,4000503],
[360000	,4000065],
[360000	,4000001],
[360000	,4000351],
[360000	,4000165],
[360000	,4000109],
[360000	,4000104],
[360000	,4000023],
[360000	,4000119],
[360000	,4000281],
[360000	,4000360],
[360000	,4000299],
[360000	,4000440],
[360000	,4000295],
[360000	,4000131],
[360000	,4000148],
[360000	,4000234],
[360000	,4000149],
[360000	,4000274],
[10000	,4000460],
[360000	,4000378],
[360000	,4000222],
[360000	,4000066],
[360000	,4000225],
[360000	,4000037],
[360000	,4000215],
[360000	,4000042],
[360000	,4000096],
[360000	,4000105],
[360000	,4000031],
[360000	,4000120],
[360000	,4000280],
[360000	,4000364],
[360000	,4000022],
[360000	,4000086],
[360000	,4000282],
[360000	,4000226],
[360000	,4000232],
[360000	,4000184],
[360000	,4000273],
[10000	,4000461],
[360000	,4000223],
[360000	,4000075],
[360000	,4000140],
[360000	,4000003],
[360000	,4000034],
[360000	,4000063],
[360000	,4000103],
[360000	,4000110],
[360000	,4000036],
[360000	,4000121],
[360000	,4000279],
[360000	,4000365],
[360000	,4000025],
[360000	,4000087],
[360000	,4000296],
[20000	,4000362],
[360000	,4000227],
[360000	,4000233],
[360000	,4000150],
[360000	,4000443],
[10000	,4000462],
[360000	,4000077],
[360000	,4000141],
[360000	,4000016],
[360000	,4000009],
[360000	,4000106],
[360000	,4000113],
[360000	,4000115],
[360000	,4000039],
[360000	,4000122],
[360000	,4000061],
[360000	,4000033],
[360000	,4000041],
[360000	,4000289],
[360000	,4000361],
[360000	,4000228],
[360000	,4000241],
[360000	,4000180],
[360000	,4000444],
[360000	,4000324],
[360000	,4000007],
[360000	,4000166],
[360000	,4000168],
[360000	,4000123],
[360000	,4000044],
[360000	,4000156],
[360000	,4000292],
[360000	,4000070],
[360000	,4000051],
[360000	,4000088],
[360000	,4000027],
[360000	,4000074],
[360000	,4000229],
[360000	,4000242],
[360000	,4000181],
[360000	,4000445],
[360000	,4000466],
[360000	,4000064],
[360000	,4000325],
[360000	,4000008],
[360000	,4000334],
[360000	,4000153],
[360000	,4000116],
[360000	,4000058],
[360000	,4000332],
[360000	,4000071],
[360000	,4000055],
[10000	,4000336],
[360000	,4000057],
[360000	,4000079],
[360000	,4000230],
[360000	,4000145],
[360000	,4000266],
[360000	,4000447],
[360000	,4000373],
[360000	,4000497],
[360000	,4000019],
[360000	,4000329],
[360000	,4000020],
[360000	,4000335],
[360000	,4000026],
[360000	,4000127],
[360000	,4000060],
[360000	,4000155],
[360000	,4000125],
[360000	,4000072],
[360000	,4000069],
[10000	,4000415],
[360000	,4000129],
[360000	,4000236],
[360000	,4000260],
[360000	,4000146],
[360000	,4000267],
[360000	,4000448],
[360000	,4000380],
[360000	,4000469],
[360000	,4000496],
[360000	,4000012],
[360000	,4000330],
[360000	,4000097],
[360000	,4000032],
[360000	,4000029],
[360000	,4000154],
[100000	,4000076],
[360000	,4000204],
[360000	,4000436],
[10000	,4000126],
[360000	,4000143],
[360000	,4000237],
[360000	,4000261],
[360000	,4000080],
[360000	,4000268],
[360000	,4000449],
[360000	,4000379],
[360000	,4000495],
[400000	,4000483],
[500000	,4000401],
[500000	,4000405],
[500000	,4000194],
[500000	,4000402],
[500000	,4000404],
[500000	,4000407],
[500000	,4000406]
]
//限制等级
var level = 50;
function start() {
	/*if (!cm.getPlayer().isGM()) {
		cm.sendOk("修复中");
		cm.dispose();
        return;
	}*/
    status = -1;
    action(1, 0, 0);
}
function action(mode, type, selection) {
    if (mode == -1) {
        cm.dispose();
    } else {
        if (mode == 1)
            status++;
        else
            status--;
        if (status == 0) {
            var strlen = "#b欢迎来到跑商玩法#k\r\n";
            strlen += "#r玩法详情： #b每次您都会接收到一个任务，您需要将我需要的材料拿来，满足我的条件后，我会给你一个奖品哦(#r每满10次将会有额外奖励哦#b)，#r每周我都会提供给你''次任务#b，做完就没有咯！";
            strlen += "\r\n#e#b#L1#领取任务#l\t#L2#查看材料列表#l"
			cm.sendSimple(strlen);
        } else if (status == 1) {
            if (selection == 1) {
				if (cm.getPlayer().getLevel() < level) {
					cm.playerMessage(1, "[注意]\r\n\r\n 此任务危险，"+level+"级以后再来尝试！");
					cm.dispose();
					return;
				}
				if(!cm.canHold(4000313,10)){
					cm.sendOk("#b背包已满，无法获取奖励，请清空背包后再试！.");
					cm.dispose();
					return;
				}
				num = cm.getBosslogManager().getBossLogW("跑商", 12, cm.getPlayer());
				num2 = cm.getBosslogManager().getBossLogW("放弃跑商", 12, cm.getPlayer());
				if (num >= times) {
					cm.sendOk("#b本周跑商已满"+times+"次！");
					cm.dispose();
					return;
				} else if (num < 0) {
					num = 0;
				}
				if (num2 < 0) {
					num2 = 0;
				}
				bossid = getOneTimeLog(cm.getPlayer().getId());
				if (bossid == -1) {
					cm.sendYesNo("你本周已完成"+num+"次跑商，放弃"+num2+"次，是否继续领取跑商任务？");
				} else {
					index1 = bossid.split(",")[0];
					index2 = bossid.split(",")[1];
					cm.sendSimple((cm.getPlayer().isGM()?index1:"")+"本次你的跑商任务材料为：#v" + index1 + "# *" + index2 + "，请选择\r\n#b#L1#提交材料#l\t#L2#放弃任务#l\t#L3#1E完成任务#l");
				}
			} else if (selection == 2) {
				var txt = "材料列表：\r\n";
				for (var i in itemlist) {
					txt += "#v" + itemlist[i][1] + "# x " + Math.ceil(itemlist[i][0]/10000) + "\r\n";
				}
				cm.sendOk(txt);
				cm.dispose()
			}
        } else if (status == 2) {
            if (bossid == -1) {
                var ran = cm.randomItemFromDrop();
                var ran = itemlist[Math.floor(Math.random() * itemlist.length)];
				
                if (ran == null) {
                    cm.sendOk("脚本出错，请联系管理员");
                    cm.dispose();
                    return;
                }
                setOneTimeLog(ran[1], cm.getPlayer().getId(), Math.ceil(ran[0]/10000));
                cm.sendOk((cm.getPlayer().isGM()?ran[1]:"")+"跑商任务领取成功，你需要收集的材料为：#v" + ran[1] + "# *" + Math.ceil(ran[0]/10000));
                cm.dispose();
                return;
            } else {
                if (selection == 1 || selection == 3) {
					if (selection == 3 && cm.getMeso() < 100000000) {
						cm.sendOk("金币不足！");
                        cm.dispose();
                        return;
					} else if (selection == 1 && !cm.haveItem(index1, index2)) {
                        cm.sendOk("材料不足！");
                        cm.dispose();
                        return;
                    } else {
                        cm.getBosslogManager().setBossLog("跑商", 12, cm.getPlayer());
						if (selection == 3) {
							if (!cm.getPlayer().isGM()) {
								cm.gainMeso(-100000000);
							}
						} else {
							cm.gainItem(index1, -index2);
						}
                        changeOneTimeLog(0, cm.getPlayer().getId(), 2);
                        var ranNX = randomRange(10, 30);
                        cm.gainPotion(2, ranNX);
                        cm.gainItem(4001028,1);
                        var txt = "恭喜你获得\r\n#r" + ranNX + "抵用券#k\r\n#r兵法卷轴#k";
                        var getExpNeededForLevel = Packages.constants.GameConstants.getExpNeededForLevel(cm.getPlayer().getLevel());
                        if(cm.getPlayer().getLevel() >= level && cm.getPlayer().getLevel() <= 99){
                            //cm.gainItem(4000313,1);
                            cm.gainExp(getExpNeededForLevel*0.05);
                            txt += "5%经验值\r\n";
                        }else if(cm.getPlayer().getLevel() >= 100 && cm.getPlayer().getLevel() <= 119){
                            //cm.gainItem(4000313,3);
                            cm.gainExp(getExpNeededForLevel*0.04);
                            txt += "4%经验值\r\n";
                        }else if(cm.getPlayer().getLevel() >= 120 && cm.getPlayer().getLevel() <= 159){
                            //cm.gainItem(4000313,5);
                            cm.gainExp(getExpNeededForLevel*0.03);
                            txt += "3%经验值\r\n";
                        }else if(cm.getPlayer().getLevel() >= 160 && cm.getPlayer().getLevel() <= 179){
                            //cm.gainItem(4000313,7);
                            cm.gainExp(getExpNeededForLevel*0.02);
                            txt += "2%经验值\r\n";
                        }else if(cm.getPlayer().getLevel() >= 180 && cm.getPlayer().getLevel() <= 200){
                            //cm.gainItem(4000313,10);
                            cm.gainExp(getExpNeededForLevel*0.01);
                            txt += "1%经验值\r\n";
                        }
                        if ((num+1)%10 == 0) {
                            //满10次，给一张祝福
                            //var x = Math.floor((num+1)/10);
                            // cm.gainItem(2340000, 1);
                            cm.gainNX(200);
                            txt += "#r点券 * 200\r\n";
                            if (Math.floor(Math.random() * 100) < 30) {
                                txt += "#v2340000# * 1 (30%几率)\r\n";
                                cm.gainItem(2340000, 1);
                            }
                            //cm.setBossRankCount("公婆抽奖", 1);
                        }
                        cm.sendOk(txt);
                        cm.dispose();
                        return;
                    }
                } else if (selection == 2) {
					if (num2 >= times) {
						cm.sendOk("#b本周放弃跑商已满"+times+"次！");
						cm.dispose();
						return;
					}
                    bossid = -2;
                    cm.sendYesNo("放弃任务将会跳过本次任务，并且需要100W手续费，是否确认放弃？");
                }
            }
        } else if (status == 3) {
            if (bossid == -2) {
                if (cm.getMeso() <= 1000000) {
                    cm.sendOk("放弃需要100W金币！");
                    cm.dispose();
                    return;
                }
                cm.gainMeso(-1000000);
                changeOneTimeLog(0, cm.getPlayer().getId(), 2);
                cm.getBosslogManager().setBossLog("放弃跑商", 12, cm.getPlayer());
                cm.sendOk("已经放弃本次任务");
                cm.dispose();
            }
        }
    }
}

function randomRange(min, max) {
    return parseInt(Math.random()*(max-min+1)+min,10);
}

function setOneTimeLog(bossid,id, num) {
	var sql = "insert into onetimelog_copy (characterid, log, num) values (?,?,?)";
	cm.sql_Update(sql, id, bossid, num);
}
function changeOneTimeLog(bossid,id, flag, num) {
    if (flag == 1) {
        //更新
        var sql = "update onetimelog_copy set log = ?, num = ? where characterid = ?";
		cm.sql_Update(sql, bossid, num, id);
    } else {
        //删除
        var sql = "delete from onetimelog_copy where characterid = ?";
        cm.sql_Update(sql, id);
    }
}

function getOneTimeLog(id) {
	var count = -1;
    var rs = cm.sql_Select("SELECT * FROM onetimelog_copy WHERE characterid = ?", id);
    if (rs.length > 0) {
		rs = rs.get(0);
        count = rs.get("log") + "," + rs.get("num");
    } else {
        count = -1;
    }
    return count;
}
